# =============================================================================
# TEMPLATES TERRAFORM - GITLAB CI/CD (VERSION REFACTORISÃ‰E)
# =============================================================================
# Description : Templates spÃ©cialisÃ©s Terraform avec gestion d'erreurs avancÃ©e
# Version     : 2.0.0 - Refactorisation DRY
# =============================================================================

# =============================================================================
# INSTALLATION TERRAFORM OPTIMISÃ‰E
# =============================================================================

.install_terraform:
  before_script:
    - echo "ðŸ” Diagnostic cache Terraform v${TF_VERSION}..."
    - |
      echo "Variables d'environnement:"
      echo "TF_ROOT: ${TF_ROOT}"
      echo "CI_PROJECT_DIR: ${CI_PROJECT_DIR}"
      echo "PWD: $(pwd)"
      
    - echo "ðŸ”§ Installation de Terraform v${TF_VERSION}..."
    - apk add --no-cache curl unzip bash git openssh ca-certificates jq
    
    # Cache optimisÃ© pour shared runners
    - export TF_CACHE_DIR="/tmp/terraform-cache-${TF_VERSION}"
    - mkdir -p "$TF_CACHE_DIR"
    
    - |
      if [ ! -f "$TF_CACHE_DIR/terraform" ]; then
        echo "ðŸ“¥ TÃ©lÃ©chargement de Terraform..."
        curl -SLO "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"
        unzip "terraform_${TF_VERSION}_linux_amd64.zip" -d "$TF_CACHE_DIR/"
        chmod +x "$TF_CACHE_DIR/terraform"
        echo "âœ… Terraform tÃ©lÃ©chargÃ© et mis en cache"
      else
        echo "â™»ï¸  Terraform trouvÃ© dans le cache"
      fi
    
    - cp "$TF_CACHE_DIR/terraform" /usr/local/bin/terraform
    - terraform --version
    - echo "âœ… Terraform installÃ© avec succÃ¨s"

# =============================================================================
# TEMPLATES DE BASE TERRAFORM
# =============================================================================

.terraform_base:
  extends: 
    - .install_terraform
    - .error_handling
  image: alpine:latest
  variables:
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "false"
    TF_CLI_ARGS: "-no-color"

.terraform_init:
  extends: .terraform_base
  script:
    - |
      echo "ðŸ”§ Initialisation Terraform pour $ENV..."
      cd ${TF_ROOT}/${ENV}
      
      # VÃ©rification de l'existence du rÃ©pertoire
      if [ ! -d "." ]; then
        echo "âŒ RÃ©pertoire $ENV non trouvÃ© dans ${TF_ROOT}"
        exit 1
      fi
      
      # Initialisation avec retry
      for attempt in 1 2 3; do
        echo "ðŸ”„ Tentative d'initialisation $attempt/3..."
        terraform init -backend=false
        if [ $? -eq 0 ]; then
          echo "âœ… Initialisation rÃ©ussie"
          break
        elif [ $attempt -eq 3 ]; then
          echo "âŒ Ã‰chec de l'initialisation aprÃ¨s 3 tentatives"
          exit 1
        else
          echo "âš ï¸  Tentative $attempt Ã©chouÃ©e, retry..."
          sleep 2
        fi
      done

# =============================================================================
# TEMPLATES SPÃ‰CIALISÃ‰S PAR STAGE
# =============================================================================

.terraform_validate:
  extends: 
    - .terraform_base
    - .base_validate
  script:
    - !reference [.validate_environment, script]
    - !reference [.terraform_init, script]
    - |
      echo "ðŸ” Validation Terraform pour $ENV..."
      cd ${TF_ROOT}/${ENV}
      
      # Validation syntaxique
      terraform validate
      if [ $? -eq 0 ]; then
        echo "âœ… Validation syntaxique rÃ©ussie"
      else
        echo "âŒ Erreurs de validation dÃ©tectÃ©es"
        exit 1
      fi
      
      # VÃ©rification des contraintes de versions
      echo "ðŸ“‹ VÃ©rification des contraintes de versions..."
      if [ -f "versions.tf" ]; then
        echo "âœ… Fichier versions.tf trouvÃ©"
        cat versions.tf | grep -E "(required_version|version)" || echo "âš ï¸  Aucune contrainte dÃ©tectÃ©e"
      else
        echo "âš ï¸  Fichier versions.tf manquant"
      fi

.terraform_plan:
  extends: 
    - .terraform_base
    - .base_plan
  variables:
    PLAN_FILE: "tfplan"
  script:
    - !reference [.validate_environment, script]
    - !reference [.terraform_init, script]
    - |
      echo "ðŸ“‹ Planification Terraform pour $ENV..."
      cd ${TF_ROOT}/${ENV}
      
      # Planification avec gestion des exit codes
      set +e  # DÃ©sactive l'arrÃªt automatique sur erreur
      terraform plan -out=${PLAN_FILE} -detailed-exitcode
      plan_exit_code=$?
      set -e  # RÃ©active l'arrÃªt automatique sur erreur
      
      echo "ðŸ” Code de sortie terraform plan: $plan_exit_code"
      
      case $plan_exit_code in
        0)
          echo "âœ… Aucun changement dÃ©tectÃ©"
          echo "PLAN_STATUS=no_changes" > ./plan_status.env
          plan_result="success"
          ;;
        1)
          echo "âŒ Erreur lors de la planification"
          echo "PLAN_STATUS=error" > ./plan_status.env
          exit 1
          ;;
        2)
          echo "ðŸ“ Changements dÃ©tectÃ©s, plan gÃ©nÃ©rÃ©"
          echo "PLAN_STATUS=changes_detected" > ./plan_status.env
          plan_result="success"
          ;;
        *)
          echo "âŒ Code de sortie inattendu: $plan_exit_code"
          echo "PLAN_STATUS=unknown_error" > ./plan_status.env
          exit 1
          ;;
      esac
      
      echo "PLAN_RESULT=$plan_result" >> ./plan_status.env
      echo "PLAN_EXIT_CODE=$plan_exit_code" >> ./plan_status.env
      
      # GÃ©nÃ©ration du rÃ©sumÃ© du plan
      echo "ðŸ“Š GÃ©nÃ©ration du rÃ©sumÃ© du plan..."
      terraform show -no-color ${PLAN_FILE} > plan_output.txt 2>&1 || true
      
      echo "=== RÃ‰SUMÃ‰ DU PLAN TERRAFORM ($ENV) ==="
      echo "Nombre de lignes: $(wc -l < plan_output.txt)"
      grep -E "(Plan:|No changes)" plan_output.txt || echo "Plan gÃ©nÃ©rÃ©"
      
      echo ""
      echo "=== APERÃ‡U DES CHANGEMENTS ==="
      head -30 plan_output.txt
      echo ""
      echo "... (plan complet sauvegardÃ© dans plan_output.txt)"
  artifacts:
    paths:
      - ${TF_ROOT}/${ENV}/${PLAN_FILE}
      - ${TF_ROOT}/${ENV}/plan_status.env
      - ${TF_ROOT}/${ENV}/plan_output.txt
    reports:
      dotenv: ${TF_ROOT}/${ENV}/plan_status.env

.terraform_apply:
  extends: 
    - .terraform_base
    - .base_apply
  variables:
    PLAN_FILE: "tfplan"
  script:
    - !reference [.validate_environment, script]
    - |
      if [ "$ENV" = "prod" ]; then
        echo "ðŸ” Validations supplÃ©mentaires pour la production..."
        if [ "$CI_COMMIT_BRANCH" != "$PRODUCTION_BRANCH" ]; then
          echo "âŒ DÃ©ploiement production autorisÃ© uniquement depuis $PRODUCTION_BRANCH"
          exit 1
        fi
        echo "ðŸ‘¤ DÃ©ploiement par: $GITLAB_USER_NAME ($GITLAB_USER_EMAIL)"
      fi
    - |
      echo "ðŸš€ Application Terraform pour $ENV..."
      cd ${TF_ROOT}/${ENV}
      
      # VÃ©rification de l'existence du plan
      if [ ! -f "${PLAN_FILE}" ]; then
        echo "âŒ Fichier plan non trouvÃ©: ${PLAN_FILE}"
        echo "ðŸ“‹ Fichiers disponibles:"
        ls -la .
        exit 1
      fi
      
      # Sauvegarde de l'Ã©tat actuel (si existe)
      if [ -f "terraform.tfstate" ]; then
        echo "ðŸ’¾ Sauvegarde de l'Ã©tat actuel..."
        cp terraform.tfstate "terraform.tfstate.backup.$(date +%Y%m%d_%H%M%S)"
      fi
      
      # Application du plan
      terraform apply -auto-approve ${PLAN_FILE}
      
      # RÃ©cupÃ©ration des outputs
      echo "ðŸ“Š RÃ©cupÃ©ration des outputs..."
      terraform output -json > terraform_outputs.json || echo "âš ï¸  Aucun output disponible"
      
      # Validation post-dÃ©ploiement
      echo "âœ… Validation post-dÃ©ploiement..."
      terraform validate || echo "âš ï¸  Validation post-dÃ©ploiement Ã©chouÃ©e"
  artifacts:
    paths:
      - ${TF_ROOT}/${ENV}/terraform_outputs.json
      - ${TF_ROOT}/${ENV}/terraform.tfstate.backup.*
      - ${TF_ROOT}/${ENV}/version-constraints.json
      - ansible/inventory/${ENV}

# =============================================================================
# TEMPLATES SPÃ‰CIALISÃ‰S PAR ENVIRONNEMENT
# =============================================================================

.terraform_validate_dev:
  extends: 
    - .terraform_validate
    - .rules_dev
  variables:
    ENV: dev

.terraform_validate_prod:
  extends: 
    - .terraform_validate
    - .rules_prod
  variables:
    ENV: prod

.terraform_plan_dev:
  extends: 
    - .terraform_plan
    - .rules_dev
  variables:
    ENV: dev

.terraform_plan_prod:
  extends: 
    - .terraform_plan
    - .rules_prod
  variables:
    ENV: prod

.terraform_apply_dev:
  extends: 
    - .terraform_apply
    - .rules_manual_dev
  variables:
    ENV: dev

.terraform_apply_prod:
  extends: 
    - .terraform_apply
    - .rules_manual_prod
  variables:
    ENV: prod
  environment:
    name: production
    action: start

# =============================================================================
# TEMPLATES DE MAINTENANCE
# =============================================================================

.terraform_cleanup:
  extends: 
    - .terraform_base
    - .base_cleanup
  script:
    - |
      echo "ðŸ§¹ Nettoyage des ressources Terraform..."
      
      # Nettoyage des anciens plans
      find ${TF_ROOT} -name "tfplan" -mtime +7 -delete 2>/dev/null || true
      find ${TF_ROOT} -name "*.backup.*" -mtime +30 -delete 2>/dev/null || true
      
      # Nettoyage des rapports de validation
      find . -name "version_validation_report.json" -mtime +7 -delete 2>/dev/null || true
      find ${TF_ROOT} -name "version-constraints.json" -mtime +30 -delete 2>/dev/null || true
      
      # Nettoyage des logs
      find /tmp -name "*.log" -mtime +1 -delete 2>/dev/null || true
      
      echo "âœ… Nettoyage Terraform terminÃ©"