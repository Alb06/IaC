# ğŸ†• VALIDATION SPÃ‰CIFIQUE DES VERSIONS TERRAFORM (VERSION AMÃ‰LIORÃ‰E)
validate_versions:
  stage: validate
  image: alpine:latest
  extends: .install_terraform
  script:
    - echo "ğŸ” Validation des contraintes de versions Terraform..."
    - apk add --no-cache jq git
    
    # VÃ©rification de l'existence des fichiers versions.tf
    - |
      echo "ğŸ“‹ VÃ©rification de la prÃ©sence des fichiers versions.tf..."
      
      required_files="terraform/globals/versions.tf terraform/environments/dev/versions.tf terraform/environments/prod/versions.tf"
      
      for file in $required_files; do
        if [ ! -f "$file" ]; then
          echo "âŒ Fichier manquant: $file"
          exit 1
        else
          echo "âœ… Fichier trouvÃ©: $file"
        fi
      done
    
    # AUTO-CORRECTION : Formatage automatique des fichiers versions.tf
    - |
      echo "ğŸ”§ Auto-formatage des fichiers versions.tf..."
      versions_files=$(find terraform/ -name "versions.tf")
      format_changes=false

      for versions_file in $versions_files; do
        echo "ğŸ”§ Formatage automatique: $versions_file"
        
        # Sauvegarde avant formatage
        cp "$versions_file" "${versions_file}.backup"
        
        # Application du formatage Terraform
        terraform fmt "$versions_file"
        
        # VÃ©rification si des changements ont Ã©tÃ© appliquÃ©s
        if ! diff -q "$versions_file" "${versions_file}.backup" > /dev/null 2>&1; then
          echo "ğŸ“ Formatage appliquÃ© Ã : $versions_file"
          format_changes=true
          
          # Affichage des changements pour information
          echo "Changements appliquÃ©s:"
          diff "${versions_file}.backup" "$versions_file" || true
        else
          echo "âœ… Fichier dÃ©jÃ  correctement formatÃ©: $versions_file"
        fi
        
        # Nettoyage de la sauvegarde
        rm "${versions_file}.backup"
      done
      
      # Information sur les changements de formatage
      if [ "$format_changes" = true ]; then
        echo "â„¹ï¸  Des changements de formatage ont Ã©tÃ© appliquÃ©s automatiquement"
        echo "   Ces changements seront inclus dans les artefacts"
      else
        echo "âœ… Tous les fichiers versions.tf sont correctement formatÃ©s"
      fi
    
    # Validation syntaxique du module globals avec contraintes
    - |
      echo "ğŸ“‹ Validation syntaxique du module globals..."
      cd terraform/globals
      terraform init -backend=false
      terraform validate
      if [ $? -eq 0 ]; then
        echo "âœ… Module globals validÃ© syntaxiquement"
      else
        echo "âŒ Erreur de syntaxe dans le module globals"
        exit 1
      fi
      cd ../../
    
    # Validation de la cohÃ©rence des contraintes entre environnements
    - |
      echo "ğŸ“‹ VÃ©rification de la cohÃ©rence des contraintes entre environnements..."
      
      # Extraction des versions Terraform des environnements avec gestion d'erreur
      extract_tf_version() {
        local file=$1
        grep -A 5 "terraform {" "$file" | grep "required_version" | sed 's/.*= *"//; s/".*//' | head -1
      }
      
      dev_tf_version=$(extract_tf_version "terraform/environments/dev/versions.tf")
      prod_tf_version=$(extract_tf_version "terraform/environments/prod/versions.tf")
      globals_tf_version=$(extract_tf_version "terraform/globals/versions.tf")
      
      echo "Dev Terraform version: '$dev_tf_version'"
      echo "Prod Terraform version: '$prod_tf_version'"
      echo "Globals Terraform version: '$globals_tf_version'"
      
      # Validation de la cohÃ©rence
      if [ "$dev_tf_version" != "$prod_tf_version" ] || [ "$dev_tf_version" != "$globals_tf_version" ]; then
        echo "âŒ ERREUR: Contraintes Terraform incohÃ©rentes"
        echo "   Dev:     '$dev_tf_version'"
        echo "   Prod:    '$prod_tf_version'"
        echo "   Globals: '$globals_tf_version'"
        exit 1
      fi
      
      # Validation que les contraintes respectent la version minimale
      if echo "$dev_tf_version" | grep -q "1.12.1"; then
        echo "âœ… Contraintes respectent la version minimale 1.12.1"
      else
        echo "âŒ Contraintes ne respectent pas la version minimale 1.12.1"
        echo "   Version dÃ©tectÃ©e: '$dev_tf_version'"
        exit 1
      fi
      
      echo "âœ… Contraintes cohÃ©rentes entre tous les environnements"
    
    # Test d'application des contraintes sur les environnements
    - |
      echo "ğŸ“‹ Test d'application des contraintes sur les environnements..."
      
      for env in dev prod; do
        echo "ğŸ§ª Test environnement: $env"
        cd "terraform/environments/$env"
        
        # Init et validation avec les nouvelles contraintes
        terraform init -backend=false
        terraform validate
        
        if [ $? -eq 0 ]; then
          echo "âœ… Environnement $env compatible avec les contraintes"
        else
          echo "âŒ Environnement $env incompatible avec les contraintes"
          exit 1
        fi
        
        cd ../../../
      done
    
    # GÃ©nÃ©ration d'un rapport de validation amÃ©liorÃ©
    - |
      echo "ğŸ“Š GÃ©nÃ©ration du rapport de validation des versions..."
      cat > version_validation_report.json << EOF
      {
        "validation_date": "$(date -Iseconds)",
        "terraform_version_used": "${TF_VERSION}",
        "validation_status": "SUCCESS",
        "auto_formatting_applied": $format_changes,
        "files_validated": [
          "terraform/globals/versions.tf",
          "terraform/environments/dev/versions.tf",
          "terraform/environments/prod/versions.tf"
        ],
        "constraints_verified": {
          "terraform_version": "$dev_tf_version",
          "provider_local": "~> 2.5",
          "provider_null": "~> 3.2"
        },
        "environments_tested": ["dev", "prod"],
        "consistency_check": "PASSED",
        "pipeline_info": {
          "runner_type": "shared",
          "branch": "$CI_COMMIT_BRANCH",
          "commit": "$CI_COMMIT_SHA"
        }
      }
      EOF
      
      echo "ğŸ“„ Rapport de validation gÃ©nÃ©rÃ©:"
      cat version_validation_report.json | jq '.'
    
    # Sauvegarde des fichiers formatÃ©s dans les artefacts
    - |
      echo "ğŸ’¾ PrÃ©paration des artefacts..."
      mkdir -p formatted_files
      cp terraform/globals/versions.tf formatted_files/globals_versions.tf
      cp terraform/environments/dev/versions.tf formatted_files/dev_versions.tf
      cp terraform/environments/prod/versions.tf formatted_files/prod_versions.tf
    
    - echo "ğŸ‰ Validation des versions Terraform terminÃ©e avec succÃ¨s"
  
  artifacts:
    paths:
      - version_validation_report.json
      - formatted_files/
    expire_in: 1 week
  
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
  # tags:
  #   - terraform

# Validation globale du code Terraform (mise Ã  jour)
validate:
  stage: validate
  image: alpine:latest
  timeout: 3m
  extends: .install_terraform
  script:
    - echo "ğŸ” Validation globale du code Terraform..."
    - cd ${TF_ROOT}
    
    # Validation du module globals (versions.tf + main.tf)
    - echo "ğŸ“‹ Validation complÃ¨te du module globals..."
    - cd ../globals && terraform init -backend=false && terraform validate
    - cd ../environments
    
    # Validation de tous les environnements avec leurs versions.tf
    - |
      for env in dev prod; do
        echo "ğŸ“‹ Validation environnement: $env"
        if [ ! -d "$env" ]; then
          echo "âŒ Dossier $env inexistant"
          exit 1
        fi
        cd "$env"
        
        # VÃ©rification de la prÃ©sence de versions.tf
        if [ ! -f "versions.tf" ]; then
          echo "âŒ Fichier versions.tf manquant dans $env"
          exit 1
        fi
        
        terraform init -backend=false
        terraform validate
        if [ $? -eq 0 ]; then
          echo "âœ… $env validÃ© avec succÃ¨s (main.tf + versions.tf)"
        else
          echo "âŒ Erreur de validation pour $env"
          exit 1
        fi
        cd ..
      done
    - echo "ğŸ‰ Validation globale rÃ©ussie avec la nouvelle structure versions"
  
  dependencies:
    - validate_versions
  
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
  # tags:
  #   - terraform