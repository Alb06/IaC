# D√©ploiement Ansible dev
ansible_dev:
  stage: deploy
  image: cytopia/ansible:latest
  variables:
    ENV: dev
  before_script:
    - echo "üîß Pr√©paration Ansible pour $ENV..."
    - apk add --no-cache jq
  script:
    - cd ${CI_PROJECT_DIR}/ansible
    
    # V√©rification de l'inventaire g√©n√©r√©
    - |
      inventory_file="inventory/${ENV}"
      if [ ! -f "$inventory_file" ]; then
        echo "‚ùå Inventaire $inventory_file non trouv√©"
        echo "Contenu du dossier inventory:"
        ls -la inventory/
        exit 1
      fi
      
      echo "‚úÖ Inventaire trouv√©: $inventory_file"
      echo "Contenu de l'inventaire:"
      cat "$inventory_file"
    
    # Test de connectivit√© Ansible
    - echo "üîç Test de connectivit√© Ansible..."
    - ansible all -i "inventory/${ENV}" -m ping || echo "‚ö†Ô∏è  Test ping √©chou√©"
    
    # Ex√©cution du playbook (si existe)
    - |
      if [ -f "playbooks/setup.yml" ]; then
        echo "üöÄ Ex√©cution du playbook setup..."
        ansible-playbook -i "inventory/${ENV}" playbooks/setup.yml --check --diff
      else
        echo "‚ÑπÔ∏è  Aucun playbook setup.yml trouv√©"
      fi
  
  dependencies:
    - apply_dev
  
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  tags:
    - ansible