# =============================================================================
# PIPELINE GITLAB CI/CD - INFRASTRUCTURE AS CODE (VERSION MODULAIRE)
# =============================================================================
# Description : Pipeline orchestrateur utilisant une architecture modulaire
# Version     : 3.0.0 - ModularisÃ© et optimisÃ©
# Migration   : Depuis pipeline monolithique v2.0.0
# Auteur      : Infrastructure Team
# =============================================================================

# ðŸ“‹ INCLUSION DES MODULES SPÃ‰CIALISÃ‰S
include:
  - local: '.gitlab/ci/includes/variables.yml'
  - local: '.gitlab/ci/includes/templates.yml'
  - local: '.gitlab/ci/includes/terraform.yml'
  - local: '.gitlab/ci/includes/ansible.yml'
  - local: '.gitlab/ci/includes/sync.yml'
  - local: '.gitlab/ci/includes/cleanup.yml'

# ðŸ”„ STAGES DU PIPELINE
stages:
  - validate     # Validation syntaxique et versions
  - plan         # Planification des changements
  - apply        # Application infrastructure
  - deploy       # DÃ©ploiement applicatif
  - sync         # Synchronisation externes
  - cleanup      # Nettoyage ressources

# =============================================================================
# ðŸ“Š MÃ‰TRIQUES ET MONITORING DU PIPELINE
# =============================================================================

# Job de monitoring des performances du pipeline
pipeline_metrics:
  stage: cleanup
  image: alpine:latest
  script:
    - echo "ðŸ“Š MÃ©triques du pipeline modulaire:"
    - echo "  - DurÃ©e totale = $(($(date +%s) - $CI_PIPELINE_CREATED_AT))"
    - echo "  - Nombre de jobs = $(echo $CI_JOB_NAME | wc -w)"
    - echo "  - Branche = $CI_COMMIT_BRANCH"
    - echo "  - Version = 3.0.0 (modulaire)"
    - |
      if [ -f ".gitlab-ci.yml.backup" ]; then
        old_lines=$(wc -l < .gitlab-ci.yml.backup)
        new_lines=$(wc -l < .gitlab-ci.yml)
        reduction=$((($old_lines - $new_lines) * 100 / $old_lines))
        echo "  - RÃ©duction code: ${reduction}% (${old_lines} â†’ ${new_lines} lignes)"
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
  allow_failure: true

# =============================================================================
# ðŸš¨ CONFIGURATION DE SÃ‰CURITÃ‰ GLOBALE
# =============================================================================

# Variables de sÃ©curitÃ© hÃ©ritÃ©es par tous les jobs
# (Les autres variables sont dans variables.yml)
variables:
  # SÃ©curitÃ© pipeline
  GIT_STRATEGY: clone
  GIT_CLEAN_FLAGS: -ffdx
  
  # MÃ©tadonnÃ©es pipeline
  PIPELINE_VERSION: "3.0.0"
  PIPELINE_TYPE: "modular"

# =============================================================================
# ðŸ“š DOCUMENTATION DE LA STRUCTURE MODULAIRE
# =============================================================================
# 
# ðŸ—‚ï¸ ORGANISATION DES MODULES :
# 
# ðŸ“„ variables.yml
#   - Variables globales (TF_VERSION, paths, etc.)
#   - Configuration cache optimisÃ©e
#   - Variables de performance
# 
# ðŸ“„ templates.yml
#   - Template .install_terraform
#   - Template .setup_ssh
#   - Templates par environnement (.dev_environment, .prod_environment)
# 
# ðŸ“„ terraform.yml
#   - Jobs validate_versions, validate
#   - Jobs plan_dev, plan_prod
#   - Jobs apply_dev, apply_prod
# 
# ðŸ“„ ansible.yml
#   - Jobs ansible_dev, ansible_prod
#   - Configuration inventaires
# 
# ðŸ“„ sync.yml
#   - Job mirror_to_github
#   - Job sync_issues_to_github
# 
# ðŸ“„ cleanup.yml
#   - Job cleanup
#   - Maintenance automatique
# 
# ðŸ“ .gitlab/scripts/
#   - Scripts bash externalisÃ©s
#   - Logique mÃ©tier modulaire
# 
# =============================================================================
# ðŸ”§ MIGRATION ET ROLLBACK
# =============================================================================
# 
# Pour revenir Ã  l'ancien pipeline en cas de problÃ¨me :
# 1. Renommer .gitlab-ci.yml en .gitlab-ci.yml.modular
# 2. Renommer .gitlab-ci.yml.backup en .gitlab-ci.yml
# 3. Pusher le changement
# 
# Pour debug le nouveau pipeline :
# 1. VÃ©rifier les includes avec GitLab CI Lint
# 2. Examiner les logs de chaque module sÃ©parÃ©ment
# 3. Utiliser les variables de debug (set -x dans les scripts)
